@echo off

rem Create local variable's stack
setlocal

if 0%__CTRL_SETLOCAL% EQU 1 (
  echo.%~nx0: error: cmd.exe is broken, please restart it!
  exit /b 65535
) >&2
set __CTRL_SETLOCAL=1

call "%%~dp0__init__/__init__.bat" || exit /b
call "%%CONTOOLS_TESTLIB_ROOT%%/init.bat" "%%~f0" || exit /b

setlocal
set "REFERENCE_1_VALUE_01="
set "REFERENCE_1_VALUE_02=	 "
set "REFERENCE_1_VALUE_03="
set "REFERENCE_1_VALUE_04=	 "
set  REFERENCE_1_VALUE_05=
set  REFERENCE_1_VALUE_06=""	 
set  REFERENCE_1_VALUE_07=	 ""
set  REFERENCE_1_VALUE_08=	 ""	 
set  REFERENCE_1_VALUE_09=	 ""
set  REFERENCE_1_VALUE_10=	 ""	 
call :TEST test_1_empty.vars TEST_1_VALUE_ REFERENCE_1_VALUE_ ^
  01 02 03 04 05 06 07 08 09 10
endlocal

setlocal
set "PARAM0="
set "PARAM1="

set "REFERENCE_2_VALUE_01=0"
set "REFERENCE_2_VALUE_02=	 0	 "
set  REFERENCE_2_VALUE_03=	 "0"	 
set "REFERENCE_2_VALUE_04=0"
set "REFERENCE_2_VALUE_05=	 0	 "
set  REFERENCE_2_VALUE_06=	 "0"	 

set "REFERENCE_2_VALUE_11=1"
set "REFERENCE_2_VALUE_12=	 1	 "
set  REFERENCE_2_VALUE_13=	 "1"	 
set "REFERENCE_2_VALUE_21="
set "REFERENCE_2_VALUE_22="
set "REFERENCE_2_VALUE_23="
set "REFERENCE_2_VALUE_31=3"
set "REFERENCE_2_VALUE_32=	 3	 "
set  REFERENCE_2_VALUE_33=	 "3"	 
set "REFERENCE_2_VALUE_41="
set "REFERENCE_2_VALUE_42="
set "REFERENCE_2_VALUE_43="

set "REFERENCE_2_VALUE_51="
set "REFERENCE_2_VALUE_52="
set "REFERENCE_2_VALUE_53="
set "REFERENCE_2_VALUE_61="
set "REFERENCE_2_VALUE_62="
set "REFERENCE_2_VALUE_63="
set "REFERENCE_2_VALUE_71="
set "REFERENCE_2_VALUE_72="
set "REFERENCE_2_VALUE_73="
set "REFERENCE_2_VALUE_81="
set "REFERENCE_2_VALUE_82="
set "REFERENCE_2_VALUE_83="

set "REFERENCE_2_VALUE_a1="
set "REFERENCE_2_VALUE_a2="
set "REFERENCE_2_VALUE_a3="
set "REFERENCE_2_VALUE_b1="
set "REFERENCE_2_VALUE_b2="
set "REFERENCE_2_VALUE_b3="
set "REFERENCE_2_VALUE_c1="
set "REFERENCE_2_VALUE_c2="
set "REFERENCE_2_VALUE_c3="
set "REFERENCE_2_VALUE_d1="
set "REFERENCE_2_VALUE_d2="
set "REFERENCE_2_VALUE_d3="
set "REFERENCE_2_VALUE_e1="
set "REFERENCE_2_VALUE_e2="
set "REFERENCE_2_VALUE_e3="

call :TEST test_2_conditional.vars TEST_2_VALUE_ REFERENCE_2_VALUE_ ^
  01 02 03 04 05 06  11 12 13  21 22 23  31 32 33  41 42 43  51 52 53  61 62 63  71 72 73  81 82 83 ^
  a1 a2 a3  b1 b2 b3  c1 c2 c3  d1 d2 d3  e1 e2 e3
endlocal

setlocal
set "PARAM0=P0"
set "PARAM1="

set "REFERENCE_2_VALUE_01=0"
set "REFERENCE_2_VALUE_02=	 0	 "
set  REFERENCE_2_VALUE_03=	 "0"	 
set "REFERENCE_2_VALUE_04=0"
set "REFERENCE_2_VALUE_05=	 0	 "
set  REFERENCE_2_VALUE_06=	 "0"	 

set "REFERENCE_2_VALUE_11=1"
set "REFERENCE_2_VALUE_12=	 1	 "
set  REFERENCE_2_VALUE_13=	 "1"	 
set "REFERENCE_2_VALUE_21="
set "REFERENCE_2_VALUE_22="
set "REFERENCE_2_VALUE_23="
set "REFERENCE_2_VALUE_31=3"
set "REFERENCE_2_VALUE_32=	 3	 "
set  REFERENCE_2_VALUE_33=	 "3"	 
set "REFERENCE_2_VALUE_41="
set "REFERENCE_2_VALUE_42="
set "REFERENCE_2_VALUE_43="

set "REFERENCE_2_VALUE_51="
set "REFERENCE_2_VALUE_52="
set "REFERENCE_2_VALUE_53="
set "REFERENCE_2_VALUE_61="
set "REFERENCE_2_VALUE_62="
set "REFERENCE_2_VALUE_63="
set "REFERENCE_2_VALUE_71="
set "REFERENCE_2_VALUE_72="
set "REFERENCE_2_VALUE_73="
set "REFERENCE_2_VALUE_81="
set "REFERENCE_2_VALUE_82="
set "REFERENCE_2_VALUE_83="

set "REFERENCE_2_VALUE_a1="
set "REFERENCE_2_VALUE_a2="
set "REFERENCE_2_VALUE_a3="
set "REFERENCE_2_VALUE_b1="
set "REFERENCE_2_VALUE_b2="
set "REFERENCE_2_VALUE_b3="
set "REFERENCE_2_VALUE_c1=3"
set "REFERENCE_2_VALUE_c2=	 3	 "
set  REFERENCE_2_VALUE_c3=	 "3"	 
set "REFERENCE_2_VALUE_d1="
set "REFERENCE_2_VALUE_d2="
set "REFERENCE_2_VALUE_d3="
set "REFERENCE_2_VALUE_e1="
set "REFERENCE_2_VALUE_e2="
set "REFERENCE_2_VALUE_e3="

call :TEST test_2_conditional.vars TEST_2_VALUE_ REFERENCE_2_VALUE_ ^
  01 02 03 04 05 06  11 12 13  21 22 23  31 32 33  41 42 43  51 52 53  61 62 63  71 72 73  81 82 83 ^
  a1 a2 a3  b1 b2 b3  c1 c2 c3  d1 d2 d3  e1 e2 e3
endlocal

setlocal
set "PARAM0="
set "PARAM1=P1"

set "REFERENCE_2_VALUE_01=0"
set "REFERENCE_2_VALUE_02=	 0	 "
set  REFERENCE_2_VALUE_03=	 "0"	 
set "REFERENCE_2_VALUE_04=0"
set "REFERENCE_2_VALUE_05=	 0	 "
set  REFERENCE_2_VALUE_06=	 "0"	 

set "REFERENCE_2_VALUE_11=1"
set "REFERENCE_2_VALUE_12=	 1	 "
set  REFERENCE_2_VALUE_13=	 "1"	 
set "REFERENCE_2_VALUE_21="
set "REFERENCE_2_VALUE_22="
set "REFERENCE_2_VALUE_23="
set "REFERENCE_2_VALUE_31=3"
set "REFERENCE_2_VALUE_32=	 3	 "
set  REFERENCE_2_VALUE_33=	 "3"	 
set "REFERENCE_2_VALUE_41="
set "REFERENCE_2_VALUE_42="
set "REFERENCE_2_VALUE_43="

set "REFERENCE_2_VALUE_51=1"
set "REFERENCE_2_VALUE_52=	 1	 "
set  REFERENCE_2_VALUE_53=	 "1"	 
set "REFERENCE_2_VALUE_61="
set "REFERENCE_2_VALUE_62="
set "REFERENCE_2_VALUE_63="
set "REFERENCE_2_VALUE_71=3"
set "REFERENCE_2_VALUE_72=	 3	 "
set  REFERENCE_2_VALUE_73=	 "3"	 
set "REFERENCE_2_VALUE_81="
set "REFERENCE_2_VALUE_82="
set "REFERENCE_2_VALUE_83="

set "REFERENCE_2_VALUE_a1="
set "REFERENCE_2_VALUE_a2="
set "REFERENCE_2_VALUE_a3="
set "REFERENCE_2_VALUE_b1=2"
set "REFERENCE_2_VALUE_b2=	 2	 "
set  REFERENCE_2_VALUE_b3=	 "2"	 
set "REFERENCE_2_VALUE_c1="
set "REFERENCE_2_VALUE_c2="
set "REFERENCE_2_VALUE_c3="
set "REFERENCE_2_VALUE_d1="
set "REFERENCE_2_VALUE_d2="
set "REFERENCE_2_VALUE_d3="
set "REFERENCE_2_VALUE_e1="
set "REFERENCE_2_VALUE_e2="
set "REFERENCE_2_VALUE_e3="

call :TEST test_2_conditional.vars TEST_2_VALUE_ REFERENCE_2_VALUE_ ^
  01 02 03 04 05 06  11 12 13  21 22 23  31 32 33  41 42 43  51 52 53  61 62 63  71 72 73  81 82 83 ^
  a1 a2 a3  b1 b2 b3  c1 c2 c3  d1 d2 d3  e1 e2 e3
endlocal

setlocal
set "PARAM0=P0"
set "PARAM1=P1"

set "REFERENCE_2_VALUE_01=0"
set "REFERENCE_2_VALUE_02=	 0	 "
set  REFERENCE_2_VALUE_03=	 "0"	 
set "REFERENCE_2_VALUE_04=0"
set "REFERENCE_2_VALUE_05=	 0	 "
set  REFERENCE_2_VALUE_06=	 "0"	 

set "REFERENCE_2_VALUE_11=1"
set "REFERENCE_2_VALUE_12=	 1	 "
set  REFERENCE_2_VALUE_13=	 "1"	 
set "REFERENCE_2_VALUE_21="
set "REFERENCE_2_VALUE_22="
set "REFERENCE_2_VALUE_23="
set "REFERENCE_2_VALUE_31=3"
set "REFERENCE_2_VALUE_32=	 3	 "
set  REFERENCE_2_VALUE_33=	 "3"	 
set "REFERENCE_2_VALUE_41="
set "REFERENCE_2_VALUE_42="
set "REFERENCE_2_VALUE_43="

set "REFERENCE_2_VALUE_51=1"
set "REFERENCE_2_VALUE_52=	 1	 "
set  REFERENCE_2_VALUE_53=	 "1"	 
set "REFERENCE_2_VALUE_61="
set "REFERENCE_2_VALUE_62="
set "REFERENCE_2_VALUE_63="
set "REFERENCE_2_VALUE_71=3"
set "REFERENCE_2_VALUE_72=	 3	 "
set  REFERENCE_2_VALUE_73=	 "3"	 
set "REFERENCE_2_VALUE_81="
set "REFERENCE_2_VALUE_82="
set "REFERENCE_2_VALUE_83="

set "REFERENCE_2_VALUE_a1=1"
set "REFERENCE_2_VALUE_a2=	 1	 "
set  REFERENCE_2_VALUE_a3=	 "1"	 
set "REFERENCE_2_VALUE_b1=2"
set "REFERENCE_2_VALUE_b2=	 2	 "
set  REFERENCE_2_VALUE_b3=	 "2"	 
set "REFERENCE_2_VALUE_c1=3"
set "REFERENCE_2_VALUE_c2=	 3	 "
set  REFERENCE_2_VALUE_c3=	 "3"	 
set "REFERENCE_2_VALUE_d1="
set "REFERENCE_2_VALUE_d2="
set "REFERENCE_2_VALUE_d3="
set "REFERENCE_2_VALUE_e1="
set "REFERENCE_2_VALUE_e2="
set "REFERENCE_2_VALUE_e3="

call :TEST test_2_conditional.vars TEST_2_VALUE_ REFERENCE_2_VALUE_ ^
  01 02 03 04 05 06  11 12 13  21 22 23  31 32 33  41 42 43  51 52 53  61 62 63  71 72 73  81 82 83 ^
  a1 a2 a3  b1 b2 b3  c1 c2 c3  d1 d2 d3  e1 e2 e3
endlocal

setlocal
set "TEST_3_VALUE_00="

set "REFERENCE_3_VALUE_11="
set "REFERENCE_3_VALUE_12=	 	 "
set  REFERENCE_3_VALUE_13=	 ""	 
set "REFERENCE_3_VALUE_21=%%"
set "REFERENCE_3_VALUE_22=	 %%	 "
set  REFERENCE_3_VALUE_23=	 "%%"	 
set "REFERENCE_3_VALUE_31=%%"
set "REFERENCE_3_VALUE_32=	 %%	 "
set  REFERENCE_3_VALUE_33=	 "%%"	 
set "REFERENCE_3_VALUE_41=%%%%"
set "REFERENCE_3_VALUE_42=	 %%%%	 "
set  REFERENCE_3_VALUE_43=	 "%%%%"	 
set "REFERENCE_3_VALUE_51="
set "REFERENCE_3_VALUE_52=	 	 "
set  REFERENCE_3_VALUE_53=	 ""	 
set "REFERENCE_3_VALUE_61=%% "
set "REFERENCE_3_VALUE_62=	 %% 	 "
set  REFERENCE_3_VALUE_63=	 "%% "	 
set "REFERENCE_3_VALUE_71="
set "REFERENCE_3_VALUE_72=	 	 "
set  REFERENCE_3_VALUE_73=	 ""	 
set "REFERENCE_3_VALUE_81=X"
set "REFERENCE_3_VALUE_82=	 X	 "
set  REFERENCE_3_VALUE_83=	 "X"	 
set "REFERENCE_3_VALUE_91=X"
set "REFERENCE_3_VALUE_92=	 X	 "
set  REFERENCE_3_VALUE_93=	 "X"	 
set "REFERENCE_3_VALUE_101="
set "REFERENCE_3_VALUE_102=	 	 "
set  REFERENCE_3_VALUE_103=	 ""	 
set "REFERENCE_3_VALUE_111=%%X%%"
set "REFERENCE_3_VALUE_112=	 %%X%%	 "
set  REFERENCE_3_VALUE_113=	 "%%X%%"	 

set "REFERENCE_3_VALUE_a1="
set "REFERENCE_3_VALUE_a2=	 	 "
set  REFERENCE_3_VALUE_a3=	 ""	 
set "REFERENCE_3_VALUE_b1="
set "REFERENCE_3_VALUE_b2=	 	 "
set  REFERENCE_3_VALUE_b3=	 ""	 
set "REFERENCE_3_VALUE_c1=%%TEST_3_VALUE_00"
set "REFERENCE_3_VALUE_c2=	 %%TEST_3_VALUE_00	 "
set  REFERENCE_3_VALUE_c3=	 "%%TEST_3_VALUE_00"	 
set "REFERENCE_3_VALUE_d1="
set "REFERENCE_3_VALUE_d2=	 	 "
set  REFERENCE_3_VALUE_d3=	 ""	 
set "REFERENCE_3_VALUE_e1=%%"
set "REFERENCE_3_VALUE_e2=	 %%	 "
set  REFERENCE_3_VALUE_e3=	 "%%"	 
set "REFERENCE_3_VALUE_f1=%%TEST_3_VALUE_00%%"
set "REFERENCE_3_VALUE_f2=	 %%TEST_3_VALUE_00%%	 "
set  REFERENCE_3_VALUE_f3=	 "%%TEST_3_VALUE_00%%"	 

set "REFERENCE_3_VALUE_g1=%"
set "REFERENCE_3_VALUE_g2=	 	 	 	 "
set  REFERENCE_3_VALUE_g3=	 "	 ""	 "	 
set "REFERENCE_3_VALUE_h1="
set "REFERENCE_3_VALUE_h2=	 	 	 	 	 	 
set  REFERENCE_3_VALUE_h3=	 "	 ""	 	 ""	 "	 
set "REFERENCE_3_VALUE_i1=%%TEST_3_VALUE_11"
set "REFERENCE_3_VALUE_i2=	 	 	 %%TEST_3_VALUE_12	 "
set  REFERENCE_3_VALUE_i3=	 "	 ""	 %%TEST_3_VALUE_13"	 
set "REFERENCE_3_VALUE_j1="
set "REFERENCE_3_VALUE_j2=	 	 	 	 
set  REFERENCE_3_VALUE_j3=	 "	 ""	 "	 
set "REFERENCE_3_VALUE_k1=%%"
set "REFERENCE_3_VALUE_k2=	 	 	 %%	 "
set  REFERENCE_3_VALUE_k3=	 "	 ""	 %%"	 
set "REFERENCE_3_VALUE_l1=%%TEST_3_VALUE_11%%"
set "REFERENCE_3_VALUE_l2=	 %%TEST_3_VALUE_12%%	 "
set  REFERENCE_3_VALUE_l3=	 "%%TEST_3_VALUE_13%%"	 

call :TEST test_3_substitution.vars TEST_3_VALUE_ REFERENCE_3_VALUE_ ^
  11 12 13  21 22 23  31 32 33  41 42 43  51 52 53  61 62 63  71 72 73  81 82 83  91 92 93   101 102 103  111 112 113 ^
  a1 a2 a3  b1 b2 b3  c1 c2 c3  d1 d2 d3  e1 e2 e3  f1 f2 f3 ^
  g1 g2 g3  h1 h2 h3  i1 i2 i3  j1 j2 j3  k1 k2 k3  l1 l2 l3
endlocal

setlocal
set  REFERENCE_4_VALUE_01=^"
set  REFERENCE_4_VALUE_02=	 "	 
set  REFERENCE_4_VALUE_03=	 """	 
set  REFERENCE_4_VALUE_11=%%"
set  REFERENCE_4_VALUE_12=	 %%"	 
set  REFERENCE_4_VALUE_13=	 "%%""	 
set "REFERENCE_4_VALUE_21="
set "REFERENCE_4_VALUE_22=	 	 
set  REFERENCE_4_VALUE_23=	 ""	 
set "REFERENCE_4_VALUE_31="
set  REFERENCE_4_VALUE_32=	 	 
set  REFERENCE_4_VALUE_33=	 ""	 
set  REFERENCE_4_VALUE_41=%%""
set  REFERENCE_4_VALUE_42=	 %%""	 
set  REFERENCE_4_VALUE_43=	 "%%"""	 
set  REFERENCE_4_VALUE_51=^^
set  REFERENCE_4_VALUE_52=	 ^^	 
set  REFERENCE_4_VALUE_53=	 "^"	 
set  REFERENCE_4_VALUE_61=^^^^
set  REFERENCE_4_VALUE_62=	 ^^^^	 
set  REFERENCE_4_VALUE_63=	 "^^"	 
set "REFERENCE_4_VALUE_71=\"
set "REFERENCE_4_VALUE_72=	 \	 "
set  REFERENCE_4_VALUE_73=	 "\"	 
set "REFERENCE_4_VALUE_81=\\"
set "REFERENCE_4_VALUE_82=	 \\	 "
set  REFERENCE_4_VALUE_83=	 "\\"	 
set  REFERENCE_4_VALUE_91=^"
set  REFERENCE_4_VALUE_92=	 "	 
set  REFERENCE_4_VALUE_93=	 """	 
set "REFERENCE_4_VALUE_101="
set  REFERENCE_4_VALUE_102=	 ""	 
set  REFERENCE_4_VALUE_103=	 """"	 

call :TEST test_4_escape.vars TEST_4_VALUE_ REFERENCE_4_VALUE_ ^
  01 02 03  11 12 13  21 22 23  31 32 33  41 42 43  51 52 53  61 62 63  71 72 73  81 82 83  91 92 93  101 102 103
endlocal

setlocal
set "REFERENCE_5_VALUE_00=#"
set "REFERENCE_5_VALUE_01=#	 "
set "REFERENCE_5_VALUE_02=	 #"
set "REFERENCE_5_VALUE_03=#"
set "REFERENCE_5_VALUE_04=	 #"
set  REFERENCE_5_VALUE_05=#""
set  REFERENCE_5_VALUE_06="" #
set  REFERENCE_5_VALUE_07=	 #""
set  REFERENCE_5_VALUE_08=	 "" #
set  REFERENCE_5_VALUE_09=	 ""#""	 
call :TEST test_5_commentary.vars TEST_5_VALUE_ REFERENCE_5_VALUE_ ^
  00 01 02 03 04 05 06 07 08 09
endlocal

setlocal
set "REFERENCE_6_VALUE_00="
set "REFERENCE_6_VALUE_01=1"
set "REFERENCE_6_VALUE_02==1"
set "REFERENCE_6_VALUE_03=	 =1	 1	 "
set "REFERENCE_6_VALUE_04= 1	 1	 "
set "REFERENCE_6_VALUE_05== 1	 1	 "
set "REFERENCE_6_VALUE_06=	 1	 ==	 "
set "REFERENCE_6_VALUE_07=="
set "REFERENCE_6_VALUE_08=	 "
set  REFERENCE_6_VALUE_09='	 "
set  REFERENCE_6_VALUE_10="	 '
set "REFERENCE_6_VALUE_11='	 '"
call :TEST test_6_specific.vars TEST_6_VALUE_ REFERENCE_6_VALUE_ ^
  00 01 02 03 04 05 06 07 08 09 10 11
endlocal

setlocal
set "TEST_7_VALUE_01=XXX"
set "TEST_7_VALUE_11=XXX"

set "REFERENCE_7_VALUE_01=XXX"
set "REFERENCE_7_VALUE_02=BBB"
set "REFERENCE_7_VALUE_11=XXX"
set "REFERENCE_7_VALUE_12=DDD"

call :TEST test_7_once.vars TEST_7_VALUE_ REFERENCE_7_VALUE_ ^
  01 02 11 12
endlocal

setlocal
set "REFERENCE_8_VALUE_01=AAA\BBB"
set "REFERENCE_8_VALUE_02=BBB\CCC"
set "REFERENCE_8_VALUE_11=AAA/BBB/CCC/DDD"
set "REFERENCE_8_VALUE_12=BBB/CCC/DDD/EEE"
set "REFERENCE_8_VALUE_21=AAA/BBB/CCC/DDD"
set "REFERENCE_8_VALUE_22=BBB/CCC/DDD/EEE"

call :TEST test_8_upath.vars TEST_8_VALUE_ REFERENCE_8_VALUE_ ^
  01 02 11 12 21 22
endlocal

setlocal
set "TEST_9_VALUE_02=x"
set "TEST_9_VALUE_03=x"
set "TEST_9_VALUE_04=x"

set "REFERENCE_9_VALUE_01=123 456/abc efg"
set "REFERENCE_9_VALUE_02=x"
set "REFERENCE_9_VALUE_03=x"
set "REFERENCE_9_VALUE_04=x"
set "REFERENCE_9_VALUE_05=;!COMSPEC!^="
set "REFERENCE_9_VALUE_06="
set "REFERENCE_9_VALUE_07="
set "REFERENCE_9_VALUE_08="
set "REFERENCE_9_VALUE_09=!"
set "REFERENCE_9_VALUE_10=!"
set "REFERENCE_9_VALUE_11="
set "REFERENCE_9_VALUE_12=!!"

set REFERENCE_9_VALUE_a1=1 ! 2 ^| 3 ^& 4 ^^ 5 = 6 , 7 ; 8 * 9 # 0 %% 1 / 2 \ 3 ? 4 ^> 5 ^< 6 " 7
set REFERENCE_9_VALUE_a2=	 1 ! 2 ^| 3 ^& 4 ^^ 5 = 6 , 7 ; 8 * 9 # 0 %% 1 / 2 \ 3 ? 4 ^> 5 ^< 6 " 7 	
set REFERENCE_9_VALUE_a3=	 1 ! 2 ^| 3 ^& 4 ^^ 5 = 6 , 7 ; 8 * 9 # 0 %% 1 / 2 \ 3 ? 4 ^> 5 ^< 6 " 7 	

call :TEST test_9_mixed.vars TEST_9_VALUE_ REFERENCE_9_VALUE_ ^
  01 02 03 04 05 06 07 08 09 10 11 12  a1 a2 a3
endlocal

echo.

rem WARNING: must be called without the call prefix!
"%CONTOOLS_TESTLIB_ROOT%/exit.bat"

rem no code can be executed here, just in case
exit /b

:TEST
echo.%~1...
call "%%CONTOOLS_TESTLIB_ROOT%%/test.bat" %%*
exit /b
